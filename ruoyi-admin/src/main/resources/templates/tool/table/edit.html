<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<meta charset="utf-8">
<head th:include="include :: header"></head>
<style>
    table label.error{
        top: 18px;
    }
</style>
<body class="white-bg">
<div class="wrapper wrapper-content animated fadeInRight ibox-content">
    <form class="form-horizontal" id="form-table-edit" name="form-table-edit" th:object="${genTable}">
        <!--表信息-->
        <div class="row">
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>表单信息
                            <small></small>
                        </h5>
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                        </div>
                    </div>

                    <div class="ibox-content">
                        <input type="hidden" name="id" th:value="*{id}" />
                        <div class="form-group">
                            <label class="col-sm-2 control-label"><font color="red">*</font>表名：</label>
                            <div class="col-sm-4">
                                <input name="name" class="form-control required" type="text" th:value="*{name}">
                            </div>
                            <label class="col-sm-2 control-label"><font color="red">*</font>说明：</label>
                            <div class="col-sm-4">
                                <input name="comments" class="form-control required" type="text" th:value="*{comments}" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">主键策略：</label>
                            <div class="col-sm-4">
                                <select class="form-control required" id="genIdTypeSelect">
                                    <option value="UUID" th:selected="*{genIdType == 'UUID'}">UUID</option>
                                    <option value="AUTO" th:selected="*{genIdType == 'AUTO'}">自增长</option>
                                </select>
                                <input type="hidden" name="genIdType" id="genIdType" th:value="*{genIdType}" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--字段信息-->
        <div class="row" th:with="columnList = *{columnList}">
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>数据库属性
                            <small style="margin-left: 10px">
                                <button class="btn btn-primary btn-xs" type="button" onclick="addtr()">
                                    <i class="fa fa-plus"></i>
                                </button>
                            </small>
                        </h5>
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                        </div>
                    </div>
                    <div class="ibox-content">
                        <table class="table table-bordered">
                            <thead>
                            <tr>
                                <th>序号</th>
                                <th><font color="red">*</font>列名</th>
                                <th><font color="red">*</font>说明</th>
                                <th>物理类型</th>
                                <th>主键</th>
                                <th>操作</th>
                            </tr>
                            </thead>

                            <template>
                            </template>

                            <tbody>
                            <!--当字段不为空时-->
                            <tr th:unless="${#lists.isEmpty(columnList)}" th:each="column:${columnList}">
                                <!--记录id-->
                                <td style="display: none;">
                                    <input type="hidden" data-name="id" th:value="${column.id}" />
                                </td>
                                <td style="position: relative">
                                    <label class="label-index" th:text="${column.orderNum}"></label>
                                    <input type="hidden" data-name="orderNum" th:value="${column.orderNum}" />
                                </td>
                                <td style="position: relative">
                                    <input type="text" class="form-control required" data-name="name" th:value="${column.name}" />
                                </td>
                                <td style="position: relative">
                                    <input type="text" class="form-control required" data-name="comments" th:value="${column.comments}" />
                                </td>
                                <td style="position: relative">
                                    <select class="form-control required"></select>
                                    <input type="hidden" data-name="jdbcType" th:value="${column.jdbcType}" />
                                </td>
                                <td style="position: relative">
                                    <div class="checkbox i-checks">
                                        <input type="checkbox" value="" th:checked="${column.isPk == '1'}" >
                                        <input type="hidden" data-name="isPk" th:value="${column.isPk}" >
                                    </div>
                                </td>
                                <td style="position: relative">
                                    <button class="btn btn-danger btn-xs" type="button" onclick="deltr(this)"><i class="fa fa-times"></i></button>
                                </td>
                            </tr>
                            <!--当字段为空时，显示默认-->
                            <tr th:if="${#lists.isEmpty(columnList)}">
                                <td style="position: relative">
                                    <label class="label-index"></label>
                                    <input type="hidden" data-name="orderNum" value="" />
                                </td>
                                <td style="position: relative">
                                    <input type="text" class="form-control required" data-name="name" value="id">
                                </td>
                                <td style="position: relative">
                                    <input type="text" class="form-control required" data-name="comments" value="主键">
                                </td>
                                <td style="position: relative">
                                    <select class="form-control required"></select>
                                    <input type="hidden" data-name="jdbcType" value="varchar(64)" />
                                </td>
                                <td style="position: relative">
                                    <div class="checkbox i-checks">
                                        <!--默认选中checked和value都要设置-->
                                        <input type="checkbox" checked >
                                        <input type="hidden" data-name="isPk" value="1" >
                                    </div>
                                </td>
                                <td style="position: relative">
                                    <button class="btn btn-danger btn-xs" type="button" onclick="deltr(this)">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(columnList)}">
                                <td style="position: relative">
                                    <label class="label-index"></label>
                                    <input type="hidden" data-name="orderNum" value="" />
                                </td>
                                <td style="position: relative">
                                    <input type="text" class="form-control required" data-name="name" value="create_by">
                                </td>
                                <td style="position: relative">
                                    <input type="text" class="form-control required" data-name="comments" value="创建者">
                                </td>
                                <td style="position: relative">
                                    <select class="form-control required"></select>
                                    <input type="hidden" data-name="jdbcType" value="varchar(64)" />
                                </td>
                                <td style="position: relative">
                                    <div class="checkbox i-checks">
                                        <!--isPk默认值为0-->
                                        <input type="checkbox" >
                                        <input type="hidden" data-name="isPk" value="0" >
                                    </div>
                                </td>
                                <td style="position: relative">
                                    <button class="btn btn-danger btn-xs" type="button" onclick="deltr(this)">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(columnList)}">
                                <td style="position: relative">
                                    <label class="label-index"></label>
                                    <input type="hidden" data-name="orderNum" value="" />
                                </td>
                                <td style="position: relative">
                                    <input type="text" class="form-control required" data-name="name" value="create_time">
                                </td>
                                <td style="position: relative">
                                    <input type="text" class="form-control required" data-name="comments" value="创建时间">
                                </td>
                                <td style="position: relative">
                                    <select class="form-control required"></select>
                                    <input type="hidden" data-name="jdbcType" value="datetime" />
                                </td>
                                <td style="position: relative">
                                    <div class="checkbox i-checks">
                                        <!--isPk默认值为0-->
                                        <input type="checkbox">
                                        <input type="hidden" data-name="isPk" value="0" >
                                    </div>
                                </td>
                                <td style="position: relative">
                                    <button class="btn btn-danger btn-xs" type="button" onclick="deltr(this)">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(columnList)}">
                                <td style="position: relative">
                                    <label class="label-index"></label>
                                    <input type="hidden" data-name="orderNum" value="" />
                                </td>
                                <td style="position: relative">
                                    <input type="text" class="form-control required" data-name="name" value="update_by">
                                </td>
                                <td style="position: relative">
                                    <input type="text" class="form-control required" data-name="comments" value="更新者">
                                </td>
                                <td style="position: relative">
                                    <select class="form-control required"></select>
                                    <input type="hidden" data-name="jdbcType" value="varchar(64)" />
                                </td>
                                <td style="position: relative">
                                    <div class="checkbox i-checks">
                                        <!--isPk默认值为0-->
                                        <input type="checkbox" >
                                        <input type="hidden" data-name="isPk" value="0" >
                                    </div>
                                </td>
                                <td style="position: relative">
                                    <button class="btn btn-danger btn-xs" type="button" onclick="deltr(this)">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(columnList)}">
                                <td style="position: relative">
                                    <label class="label-index"></label>
                                    <input type="hidden" data-name="orderNum" value="" />
                                </td>
                                <td style="position: relative">
                                    <input type="text" class="form-control required" data-name="name" value="update_time">
                                </td>
                                <td style="position: relative">
                                    <input type="text" class="form-control required" data-name="comments" value="更新时间">
                                </td>
                                <td style="position: relative">
                                    <select class="form-control required"></select>
                                    <input type="hidden" data-name="jdbcType" value="datetime" />
                                </td>
                                <td style="position: relative">
                                    <div class="checkbox i-checks">
                                        <!--isPk默认值为0-->
                                        <input type="checkbox" >
                                        <input type="hidden" data-name="isPk" value="0" >
                                    </div>
                                </td>
                                <td style="position: relative">
                                    <button class="btn btn-danger btn-xs" type="button" onclick="deltr(this)">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(columnList)}">
                                <td style="position: relative">
                                    <label class="label-index"></label>
                                    <input type="hidden" data-name="orderNum" value="" />
                                </td>
                                <td style="position: relative">
                                    <input type="text" class="form-control required" data-name="name" value="remark">
                                </td>
                                <td style="position: relative">
                                    <input type="text" class="form-control required" data-name="comments" value="备注信息">
                                </td>
                                <td style="position: relative">
                                    <select class="form-control required"></select>
                                    <input type="hidden" data-name="jdbcType" value="nvarchar(255)" />
                                </td>
                                <td style="position: relative">
                                    <div class="checkbox i-checks">
                                        <!--isPk默认值为0-->
                                        <input type="checkbox" >
                                        <input type="hidden" data-name="isPk" value="0" >
                                    </div>
                                </td>
                                <td style="position: relative">
                                    <button class="btn btn-danger btn-xs" type="button" onclick="deltr(this)">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(columnList)}">
                                <td style="position: relative">
                                    <label class="label-index"></label>
                                    <input type="hidden" data-name="orderNum" value="" />
                                </td>
                                <td style="position: relative">
                                    <input type="text" class="form-control required" data-name="name" value="del_flag">
                                </td>
                                <td style="position: relative">
                                    <input type="text" class="form-control required" data-name="comments" value="删除标志（0代表存在 2代表删除）">
                                </td>
                                <td style="position: relative">
                                    <select class="form-control required"></select>
                                    <input type="hidden" data-name="jdbcType" value="varchar(64)" />
                                </td>
                                <td style="position: relative">
                                    <div class="checkbox i-checks">
                                        <!--isPk默认值为0-->
                                        <input type="checkbox" >
                                        <input type="hidden" data-name="isPk" value="0" >
                                    </div>
                                </td>
                                <td style="position: relative">
                                    <button class="btn btn-danger btn-xs" type="button" onclick="deltr(this)">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
<div th:include="include::footer"></div>
<script th:src="@{/js/jquery-ui-1.10.4.min.js}"></script>
<script th:inline="javascript">
    var prefix = ctx + "tool/table";
    var selectdata = [[${@dict.getType('sys_field_type')}]];
    // 定义第一行tr副本
    var copy = '<tr><td style="position: relative"><label class="label-index"></label><input type="hidden" data-name="orderNum" value="" /></td>' +
        '<td style="position: relative"><input type="text" class="form-control required" data-name="name" value=""></td>' +
        '<td style="position: relative"><input type="text" class="form-control required" data-name="comments" value=""></td>' +
        '<td style="position: relative"><select class="form-control required"></select><input type="hidden" data-name="jdbcType" /></td>' +
        '<td style="position: relative"><div class="checkbox i-checks"><input type="checkbox" ><input type="hidden" data-name="isPk" value="0" ></div></td>' +
        '<td style="position: relative"><button class="btn btn-danger btn-xs" type="button" onclick="deltr(this)"><i class="fa fa-times"></i></button></td>' +
        '</tr>';
    // 定义操作栏的移除按钮
    var rmbtn = '<button class="btn btn-danger btn-xs" type="button" onclick="deltr(this)"><i class="fa fa-times"></i></button>';

    $(function () {
        $("table tr").each(function (index, tr) {
            initTableWidget(tr);
        })
        $("table").sortable({items: "tr", cursor: 'move', axis: "y",stop:function () {restIndexAndBtn();}}); // 可拖拽排序
        restIndexAndBtn();
    })

    function addtr(){
        if(copy){
            var _copy = $(copy).clone();
            initTableWidget(_copy);
            _copy.appendTo($('table'));
            restIndexAndBtn();
        }
    }

    function deltr(obj){
        var tr = obj.parentNode.parentNode;//obj.parentNode.parentNode是<tr>
        tr.remove();
        restIndexAndBtn();
    }

    function bindSelect2($select) {
        var $input = $select.parent().find('input[type="hidden"]'); // 初始化时检查对应的input是否有值
        var isMatchedFlag = false;
        var _data = $.map(selectdata, function (obj) {
            var result = {};
            result.id = obj.dictLabel;
            result.text = obj.dictValue;
            if ($input.val() == obj.dictValue) {
                result.selected = true;
                isMatchedFlag = true;
            }
            return result;
        });
        // 当input有值并且没有匹配到默认的选项(即设置的值不在字典里)，创建新tag
        if (!isMatchedFlag && $input.val()) {
            var tagData = {
                id: $input.val(),
                text: $input.val(),
                selected: true
            }
            _data.unshift(tagData);
        }
        $select.select2({
            tags: true,
            data: _data
        });
    }

    function bindCheckBox($checkbox) {
        $checkbox.iCheck({
            checkboxClass: 'icheckbox_square-green',
            radioClass: 'iradio_square-green'
        });
        // 绑定事件
        $checkbox.find('input[type="checkbox"]').on('ifChecked', function () {
            $(this).parent().next('input[data-name]').val('1');
        });
        $checkbox.find('input[type="checkbox"]').on('ifUnchecked', function () {
            $(this).parent().next('input[data-name]').val('0');
        });
    }

    // 初始化动态table控件
    function initTableWidget(_tr) {
        bindSelect2($(_tr).find('select'));
        bindCheckBox($(_tr).find('.i-checks'));
    }

    function restIndexAndBtn(){
        $('table tr').each(function (index, tr) {
            // 重建索引
            var $label = $(tr).find('label.label-index');
            $label.next('input[type="hidden"]').val(index); // 赋值orderNum
            $label.html(index);
            // 重建删除按钮
            $(tr).find('td').eq(-1).find('button').remove();
            index != 1 ? $(rmbtn).appendTo($(tr).find('td').eq(-1)) : false;
        })
    }

    function doBeforeSubmit() {
        $('#genIdType').val($('#genIdTypeSelect').val());
        var colFieldName = 'columnList';
        $('table tr').each(function (index, tr) {
            var $select = $(tr).find('select');
            $select.parent().find('input').val($select.val());
            var $input = $(tr).find('input[data-name]');
            // 为每个input改名
            $input.each(function (i, input) {
                $(input).attr("name", colFieldName + '[' + parseInt(index - 1) + '].' + $(input).data("name"));
            })
        })
    }

    function submitHandler() {
        doBeforeSubmit();  // 为动态table创建name，赋值数据
        if ($.validate.form()) {
            $.operate.save(prefix + "/edit", $('#form-table-edit').serialize());
        }
    }

</script>
</body>
</html>
